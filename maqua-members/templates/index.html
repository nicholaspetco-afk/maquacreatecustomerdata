<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAQUA 會員專區</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='members.css') }}">
</head>

<body class="auth-locked">
  <div id="authGate" class="auth-gate">
    <div class="auth-card">
      <h2 class="auth-title">MAQUA 安全驗證</h2>
      <p class="auth-desc">請輸入訪問密碼以開啟會員資料。</p>
      <form id="authForm" class="auth-form">
        <input id="authInput" class="auth-input" type="password" placeholder="輸入密碼" autocomplete="off" required>
        <button type="submit" class="auth-btn">解鎖</button>
      </form>
      <p id="authError" class="auth-error" hidden>密碼錯誤，請再試一次。</p>
    </div>
  </div>

  <header class="member-header">
    <div class="member-hero">
      <p class="member-kicker">MAQUA Membership</p>
      <h1 class="member-title">會員專屬保養資訊</h1>
      <p class="member-subtitle">輸入客戶編碼或電話，快速掌握保養日期、合約與月費方案。</p>
    </div>
  </header>

  <main class="member-container">
    <section class="member-card">
      <form id="memberForm" class="member-form">
        <label class="member-label" for="memberInput">客戶編碼 / 聯絡電話</label>
        <div class="member-field">
          <input id="memberInput" class="member-input" placeholder="例如：C3770 或 66851573" autocomplete="off" required>
          <button type="submit" class="member-btn">查詢</button>
        </div>
        <p class="member-hint">* 搜尋會優先以「維修幫」的保養紀錄顯示最近兩次服務日期。</p>
      </form>
      <div id="memberStatus" class="member-status"></div>
    </section>

    <section id="memberResult" class="member-card result-card" hidden>
      <div class="result-header">
        <div>
          <p class="result-label">會員名稱</p>
          <h2 id="resultName" class="result-title">—</h2>
        </div>
        <div class="result-meta">
          <span class="meta-item">
            <span class="meta-label">客戶編碼</span>
            <span id="resultCode">—</span>
          </span>
          <span class="meta-item">
            <span class="meta-label">輸入關鍵字</span>
            <span id="resultKeyword">—</span>
          </span>
        </div>
      </div>

      <div class="info-grid">
        <article class="info-card contract-card">
          <h3>保養排程</h3>
          <div class="info-content">
            <div class="info-line">
              <span class="info-label">下次保養</span>
              <span id="resultNext" class="info-value">—</span>
            </div>
            <div class="info-line">
              <span class="info-label">最近一次</span>
              <span id="resultLatest" class="info-value">—</span>
            </div>
            <div class="info-line">
              <span class="info-label">付款情況</span>
              <span id="resultPaymentStatus" class="info-value">—</span>
            </div>
          </div>
        </article>

        <article class="info-card">
          <h3>合約與方案</h3>
          <div class="info-content">
            <div class="info-line">
              <span class="info-label">合約編號</span>
              <span id="resultContract" class="info-value">—</span>
            </div>
            <div class="info-line">
              <span class="info-label">客戶行業</span>
              <span id="resultIndustry" class="info-value">—</span>
            </div>
            <div class="info-line" id="planSummaryRow">
              <span class="info-label">方案類型</span>
              <span id="resultPlan" class="info-value">—</span>
            </div>
            <div id="planList" class="plan-list"></div>
            <div class="info-line">
              <span class="info-label">使用方式</span>
              <span id="resultUsage" class="info-value">—</span>
            </div>
            <div class="info-line">
              <span class="info-label">月費金額</span>
              <span id="resultFee" class="info-value">—</span>
            </div>
            <div class="info-line">
              <span class="info-label">付費方式</span>
              <span id="resultPayment" class="info-value">—</span>
            </div>
          </div>
        </article>

        <article class="info-card">
          <h3>聯絡資訊</h3>
          <div class="info-content">
            <div class="info-line">
              <span class="info-label">聯絡人</span>
              <span id="resultContact" class="info-value">—</span>
            </div>
            <div class="info-line">
              <span class="info-label">電話</span>
              <span id="resultPhone" class="info-value">—</span>
            </div>
            <div class="info-line">
              <span class="info-label">預設地址</span>
              <span id="resultAddress" class="info-value">—</span>
            </div>
          </div>
        </article>
      </div>
    </section>

    <section class="member-card import-card">
      <h2 class="member-title">銷售文案一鍵建檔</h2>
      <p class="member-hint">貼上從銷售或行政取得的客戶文案，一鍵解析並送出 CRM（預設會自動審批）。</p>
      <form id="importForm" class="member-form">
        <label class="member-label" for="importInput">貼上文案</label>
        <textarea id="importInput" class="import-textarea" placeholder="客戶名稱：澳門關閘集團 C99996&#10;聯繫電話：63588818劉生&#10;..."
          required></textarea>
        <label class="import-option">
          <input id="importSkipAudit" type="checkbox">
          只送出申請，暫不啟動自動審批
        </label>
        <div class="import-actions">
          <button id="importSubmit" type="submit" class="member-btn">送出 CRM</button>
          <button id="opportunityButton" type="button" class="member-btn ghost" hidden>新增商機</button>
          <button id="taskButton" type="button" class="member-btn ghost" hidden>新增任務</button>
        </div>
      </form>
      <div id="importStatus" class="member-status"></div>
      <div id="opportunityStatus" class="member-status" hidden></div>
      <div id="taskStatus" class="member-status" hidden></div>
      <pre id="importResult" class="import-result" hidden></pre>
    </section>
  </main>

  <div id="planModal" class="plan-modal" hidden>
    <div class="plan-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="planModalTitle">
      <button type="button" id="planModalClose" class="plan-modal-close" aria-label="關閉">×</button>
      <div class="plan-detail-header" id="planModalHeader">
        <span id="planModalTitle">—</span>
      </div>
      <dl id="planModalBody" class="plan-detail-body"></dl>
      <div id="planModalLink" class="plan-detail-link-container" hidden>
        <a id="planModalLinkAnchor" class="plan-detail-link" href="#" target="_blank" rel="noopener">前往商機頁面</a>
      </div>
    </div>
  </div>

  <footer class="member-footer">
    <p>MAQUA · 你的專屬淨水管家</p>
  </footer>

  <script>
    const AUTH_PASSWORD = 'maqua28453792';
    const AUTH_STORAGE_KEY = 'maqua-auth-status';

    const authGate = document.getElementById('authGate');
    const authForm = document.getElementById('authForm');
    const authInput = document.getElementById('authInput');
    const authError = document.getElementById('authError');

    const form = document.getElementById('memberForm');
    const input = document.getElementById('memberInput');
    const statusEl = document.getElementById('memberStatus');
    const resultSection = document.getElementById('memberResult');

    const resultName = document.getElementById('resultName');
    const resultCode = document.getElementById('resultCode');
    const resultKeyword = document.getElementById('resultKeyword');
    const resultLatest = document.getElementById('resultLatest');
    const resultNext = document.getElementById('resultNext');
    const resultContract = document.getElementById('resultContract');
    const resultPlan = document.getElementById('resultPlan');
    const resultUsage = document.getElementById('resultUsage');
    const resultFee = document.getElementById('resultFee');
    const resultPayment = document.getElementById('resultPayment');
    const resultPaymentStatus = document.getElementById('resultPaymentStatus');
    const resultIndustry = document.getElementById('resultIndustry');
    const planSummaryRow = document.getElementById('planSummaryRow');
    const planListEl = document.getElementById('planList');
    const planModal = document.getElementById('planModal');
    const planModalHeader = document.getElementById('planModalHeader');
    const planModalTitle = document.getElementById('planModalTitle');
    const planModalBody = document.getElementById('planModalBody');
    const planModalLink = document.getElementById('planModalLink');
    const planModalLinkAnchor = document.getElementById('planModalLinkAnchor');
    const planModalClose = document.getElementById('planModalClose');
    const resultAddress = document.getElementById('resultAddress');
    const resultContact = document.getElementById('resultContact');
    const resultPhone = document.getElementById('resultPhone');
    const importForm = document.getElementById('importForm');
    const importInput = document.getElementById('importInput');
    const importSkipAudit = document.getElementById('importSkipAudit');
    const importStatus = document.getElementById('importStatus');
    const importResult = document.getElementById('importResult');
    const importSubmit = document.getElementById('importSubmit');
    const opportunityButton = document.getElementById('opportunityButton');
    const opportunityStatus = document.getElementById('opportunityStatus');
    const taskButton = document.getElementById('taskButton');
    const taskStatus = document.getElementById('taskStatus');
    let currentOpportunityToken = '';
    let currentCustomerCode = '';

    let fallbackPlanSummary = '—';
    let activePlanIndex = null;
    let authUnlocked = false;

    function unlockApplication() {
      if (authUnlocked) {
        return;
      }
      authUnlocked = true;
      sessionStorage.setItem(AUTH_STORAGE_KEY, '1');
      document.body.classList.remove('auth-locked');
      if (authGate) {
        authGate.style.display = 'none';
        authGate.setAttribute('aria-hidden', 'true');
      }
      if (authError) {
        authError.hidden = true;
      }
      if (authInput) {
        authInput.value = '';
      }
      if (input) {
        setTimeout(() => input.focus(), 50);
      }
    }

    if (sessionStorage.getItem(AUTH_STORAGE_KEY) === '1') {
      unlockApplication();
    } else if (authInput) {
      setTimeout(() => authInput.focus(), 100);
    }

    if (authForm) {
      authForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (authUnlocked) {
          return;
        }
        const value = (authInput && authInput.value ? authInput.value : '').trim();
        if (value === AUTH_PASSWORD) {
          unlockApplication();
        } else {
          if (authError) {
            authError.hidden = false;
          }
          if (authInput) {
            authInput.value = '';
            authInput.focus();
          }
        }
      });
    }

    function hidePlanModal() {
      if (!planModal || planModal.hasAttribute('hidden')) {
        return;
      }
      planModal.classList.remove('open');
      planModal.setAttribute('hidden', 'hidden');
      planModalBody.innerHTML = '';
      planModalLink.hidden = true;
      if (planModalHeader) {
        planModalHeader.hidden = true;
      }
      if (planModalTitle) {
        planModalTitle.textContent = '';
      }
      if (activePlanIndex !== null) {
        const chips = planListEl.querySelectorAll('.plan-chip');
        const activeChip = chips[activePlanIndex];
        if (activeChip && typeof activeChip.focus === 'function') {
          activeChip.focus({ preventScroll: true });
        }
      }
    }

    function openPlanModal(plan) {
      if (!planModal || !plan) {
        return;
      }

      const detailItems = Array.isArray(plan.details)
        ? plan.details.filter((item) => item && item.value)
        : [];
      const preferredLabels = [
        '合約編號',
        '方案類型',
        '使用方式',
        '付費方式',
        '月費金額',
        '合約開始日',
        '合約結束日',
        '合約年期',
        '預計簽單金額',
      ];
      const secondaryLabels = [
        '商機階段',
        '方案負責人',
        '交易類型',
        '安裝位置',
      ];
      const filtered = [];
      const seen = new Set();

      function appendByLabels(labels) {
        labels.forEach((label) => {
          detailItems.forEach((item) => {
            if (item.label === label) {
              const key = `${item.label}::${item.value}`;
              if (!seen.has(key)) {
                filtered.push(item);
                seen.add(key);
              }
            }
          });
        });
      }

      appendByLabels(preferredLabels);

      const monthlyFromPlan = plan.monthlyFee;
      const monthlyDisplay = monthlyFromPlan && monthlyFromPlan !== '—'
        ? String(monthlyFromPlan).trim()
        : '';
      if (monthlyDisplay) {
        const monthlyKey = `月費金額::${monthlyDisplay}`;
        if (!seen.has(monthlyKey)) {
          filtered.splice(Math.min(2, filtered.length), 0, { label: '月費金額', value: monthlyDisplay });
          seen.add(monthlyKey);
        }
      }

      appendByLabels(secondaryLabels);

      const itemsToRender = filtered.length > 0 ? filtered : detailItems;

      if (itemsToRender.length === 0 && !plan.detailUrl) {
        return;
      }

      if (planModalHeader) {
        planModalHeader.hidden = true;
      }
      if (planModalTitle) {
        planModalTitle.textContent = '';
      }
      planModalBody.innerHTML = '';

      itemsToRender.forEach((item) => {
        const dt = document.createElement('dt');
        dt.textContent = item.label || '項目';
        const dd = document.createElement('dd');
        dd.textContent = item.value;
        planModalBody.appendChild(dt);
        planModalBody.appendChild(dd);
      });

      if (plan.detailUrl) {
        planModalLinkAnchor.href = plan.detailUrl;
        planModalLink.hidden = false;
      } else {
        planModalLink.hidden = true;
      }

      planModal.removeAttribute('hidden');
      requestAnimationFrame(() => {
        planModal.classList.add('open');
        if (planModalClose && typeof planModalClose.focus === 'function') {
          planModalClose.focus({ preventScroll: true });
        }
      });
    }

    function renderPlans(plans) {
      planListEl.innerHTML = '';
      hidePlanModal();
      activePlanIndex = null;

      if (!Array.isArray(plans) || plans.length === 0) {
        if (planSummaryRow) {
          planSummaryRow.hidden = false;
        }
        resultPlan.textContent = fallbackPlanSummary;
        return;
      }

      plans.forEach((plan, index) => {
        const label = plan.title || plan.summary || `方案 ${index + 1}`;
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'plan-chip';
        button.textContent = label;
        button.addEventListener('click', () => showPlanDetail(plans, index));
        planListEl.appendChild(button);
      });
    }


    function showPlanDetail(plans, selectedIndex) {
      if (!Array.isArray(plans) || !plans[selectedIndex]) {
        return;
      }

      activePlanIndex = selectedIndex;

      planListEl.querySelectorAll('.plan-chip').forEach((btn, idx) => {
        btn.classList.toggle('active', idx === selectedIndex);
      });

      openPlanModal(plans[selectedIndex]);
    }

    if (planModal) {
      planModal.addEventListener('click', (event) => {
        if (event.target === planModal) {
          hidePlanModal();
        }
      });
    }
    if (planModalClose) {
      planModalClose.addEventListener('click', hidePlanModal);
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        hidePlanModal();
      }
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const keyword = input.value.trim();
      if (!keyword) {
        statusEl.textContent = '請輸入資訊後查詢。';
        return;
      }

      resultSection.hidden = true;
      fallbackPlanSummary = '—';
      renderPlans([]);
      resultPaymentStatus.textContent = '—';
      statusEl.textContent = '查詢中，請稍候…';

      try {
        const response = await fetch('{{ url_for('profile_api') }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier: keyword })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({ message: '查詢失敗' }));
          statusEl.textContent = err.message || '查詢失敗，請稍後再試。';
          renderPlans([]);
          return;
        }

        const data = await response.json();
        const profile = data.profile || {};

        resultName.textContent = profile.customerName || '—';
        resultCode.textContent = profile.customerCode || '—';
        resultKeyword.textContent = profile.keyword || keyword;
        resultNext.textContent = profile.nextServiceDate || '—';
        resultLatest.textContent = profile.latestServiceDate || '—';
        resultContract.textContent = profile.contractNumber || '—';
        fallbackPlanSummary = profile.planType || '—';
        resultPlan.textContent = fallbackPlanSummary;
        resultUsage.textContent = profile.usage || '—';
        resultFee.textContent = profile.monthlyFee || '—';
        resultPaymentStatus.textContent = profile.paymentStatus || '—';
        resultPayment.textContent = profile.paymentMethod || '—';
        resultIndustry.textContent = profile.customerIndustry || '—';
        resultAddress.textContent = profile.address || '—';
        const resolvedContact = (profile.contact && profile.contact.name) || profile.customerName;
        resultContact.textContent = resolvedContact || '—';
        resultPhone.textContent = (profile.contact && profile.contact.phone) || '—';
        const plans = Array.isArray(profile.plans) ? profile.plans : [];
        renderPlans(plans);

        resultSection.hidden = false;
        statusEl.textContent = '';
      } catch (error) {
        console.error(error);
        statusEl.textContent = '查詢時發生錯誤，請稍後再試。';
        fallbackPlanSummary = '—';
        renderPlans([]);
        resultPaymentStatus.textContent = '—';
      }
    });

    if (importForm) {
      importForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const salesText = (importInput && importInput.value ? importInput.value : '').trim();
        if (!salesText) {
          if (importStatus) importStatus.textContent = '請貼上完整文案。';
          return;
        }
        if (importStatus) importStatus.textContent = '送出中，請稍候…';
        if (importResult) {
          importResult.hidden = true;
          importResult.textContent = '';
        }
        if (importSubmit) importSubmit.disabled = true;
        currentOpportunityToken = '';
        currentCustomerCode = '';
        if (opportunityButton) {
          opportunityButton.hidden = true;
          opportunityButton.disabled = false;
        }
        if (taskButton) {
          taskButton.hidden = true;
          taskButton.disabled = false;
        }
        if (opportunityStatus) {
          opportunityStatus.hidden = true;
          opportunityStatus.textContent = '';
        }
        if (taskStatus) {
          taskStatus.hidden = true;
          taskStatus.textContent = '';
        }

        try {
          const response = await fetch('{{ url_for('import_customer_api') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: salesText,
              skipAudit: importSkipAudit ? importSkipAudit.checked : false,
            }),
          });

          const raw = await response.text();
          let payload;
          try {
            payload = raw ? JSON.parse(raw) : {};
          } catch (err) {
            payload = { raw };
          }

          if (!response.ok) {
            if (importStatus) importStatus.textContent = payload.message || payload.raw || '送出失敗，請稍後再試。';
            if (importResult) {
              importResult.textContent = raw;
              importResult.hidden = false;
            }
            return;
          }

          const resultData = payload.result || payload;
          let statusMessage = '送出完成。';
          if (resultData.message) {
            statusMessage = resultData.message;
          } else if (!resultData.submitted) {
            statusMessage = '查重未通過，請檢查文案是否有重複客戶。';
          } else if (resultData.auditResponse && resultData.auditResponse.error) {
            statusMessage = `申請已送出，但審批失敗：${resultData.auditResponse.error}`;
          } else if (
            resultData.applicationResponse &&
            resultData.applicationResponse.code &&
            resultData.applicationResponse.code !== '200'
          ) {
            statusMessage = `送出完成，但 CRM 回傳 ${resultData.applicationResponse.code}`;
          }

          if (importStatus) importStatus.textContent = statusMessage;
          if (importResult) {
            importResult.textContent = JSON.stringify(resultData, null, 2);
            importResult.hidden = false;
          }
          currentCustomerCode =
            (resultData.normalized && (resultData.normalized.customerCode || resultData.normalized.customer_code)) ||
            resultData.customerCode ||
            resultData.customer_code ||
            '';
          currentCustomerCode =
            currentCustomerCode ||
            resultData.customerCode ||
            resultData.customer_code ||
            (resultData.normalized && (resultData.normalized.customerCode || resultData.normalized.customer_code)) ||
            '';
          const sessionInfo = resultData.opportunitySession;
          if (sessionInfo && sessionInfo.token) {
            currentOpportunityToken = sessionInfo.token;
            if (opportunityButton) {
              opportunityButton.hidden = false;
              opportunityButton.disabled = false;
              opportunityButton.textContent = '新增商機';
            }
            if (opportunityStatus) {
              opportunityStatus.hidden = false;
              opportunityStatus.textContent = '客戶建立成功，如需加入商機請點「新增商機」。';
            }
            // 緩存 token，刷新頁面也能直接建商機
            try {
              localStorage.setItem(
                LS_KEY_OPP,
                JSON.stringify({ token: currentOpportunityToken, customerCode: currentCustomerCode })
              );
            } catch (e) {
              console.warn('persist session failed', e);
            }
          } else {
            currentOpportunityToken = '';
            if (opportunityButton) opportunityButton.hidden = true;
            if (opportunityStatus) opportunityStatus.hidden = true;
            try { localStorage.removeItem(LS_KEY_OPP); } catch (e) {}
          }
        } catch (error) {
          console.error(error);
          if (importStatus) importStatus.textContent = '送出時發生錯誤，請稍後再試。';
        } finally {
          if (importSubmit) importSubmit.disabled = false;
        }
      });
    }

    let isCreatingOpportunity = false;  // 防重複提交標記
    const LS_KEY_OPP = 'maqua_opp_session';

    // 嘗試恢復上次成功提交的商機 session（避免刷新後要重填）
    (function restoreOpportunitySession() {
      try {
        const cached = localStorage.getItem(LS_KEY_OPP);
        if (!cached) return;
        const parsed = JSON.parse(cached);
        if (parsed && parsed.token) {
          currentOpportunityToken = parsed.token;
          currentCustomerCode = parsed.customerCode || '';
          if (opportunityButton) {
            opportunityButton.hidden = false;
            opportunityButton.disabled = false;
            opportunityButton.textContent = '新增商機';
          }
          if (opportunityStatus) {
            opportunityStatus.hidden = false;
            opportunityStatus.textContent = '已恢復上次提交的客戶，可直接點「新增商機」。';
          }
        }
      } catch (e) {
        console.warn('restore session failed', e);
      }
    })();

    if (opportunityButton) {
      opportunityButton.addEventListener('click', async () => {
        // 防止重複點擊
        if (isCreatingOpportunity) {
          console.log('[防重複] 商機正在創建中，忽略此次點擊');
          return;
        }

        if (!currentOpportunityToken) {
          if (opportunityStatus) {
            opportunityStatus.hidden = false;
            opportunityStatus.textContent = '目前沒有可送出的商機資料。';
          }
          return;
        }

        // 設置標記，防止重複提交
        isCreatingOpportunity = true;
        opportunityButton.disabled = true;
        opportunityButton.textContent = '提交中...';

        if (opportunityStatus) {
          opportunityStatus.hidden = false;
          opportunityStatus.textContent = '商機建立中…';
        }
        try {
          const response = await fetch('{{ url_for('create_opportunity_api') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: currentOpportunityToken }),
          });
          const raw = await response.text();
          let payload;
          try {
            payload = raw ? JSON.parse(raw) : {};
          } catch (err) {
            payload = { raw };
          }
          if (!response.ok) {
            const message = payload.message || payload.raw || '商機建立失敗，請稍後再試。';
            if (opportunityStatus) {
              opportunityStatus.textContent = message;
            }
            // 失敗時重置按鈕
            opportunityButton.disabled = false;
            opportunityButton.textContent = '新增商機';
            isCreatingOpportunity = false;
            return;
          }
          const result = payload.result || payload;
          if (importResult) {
            importResult.textContent = JSON.stringify(result, null, 2);
            importResult.hidden = false;
          }
          currentCustomerCode =
            currentCustomerCode ||
            result.customerCode ||
            result.customer_code ||
            (result.normalized && (result.normalized.customerCode || result.normalized.customer_code)) ||
            '';
          if (opportunityStatus) {
            const reason = result.reason || result.message;
            if (result.success) {
              opportunityStatus.textContent = '商機建立成功。';
            } else if (reason) {
              opportunityStatus.textContent = reason;
            } else {
              opportunityStatus.textContent = '商機已送出。';
            }
          }
          if (result.success) {
            currentOpportunityToken = '';
            opportunityButton.hidden = true;
            if (taskButton) {
              taskButton.hidden = false;
              taskButton.disabled = false;
            }
            try { localStorage.removeItem(LS_KEY_OPP); } catch (e) {}
          } else {
            // 失敗時重置按鈕
            opportunityButton.disabled = false;
            opportunityButton.textContent = '新增商機';
            isCreatingOpportunity = false;
          }
        } catch (error) {
          console.error(error);
          if (opportunityStatus) {
            opportunityStatus.textContent = '商機建立時發生錯誤，請稍後重試。';
          }
          // 錯誤時重置按鈕
          opportunityButton.disabled = false;
          opportunityButton.textContent = '新增商機';
          isCreatingOpportunity = false;
        }
        // 請求結束後若按鈕仍可見，恢復文字與狀態
        if (!opportunityButton.hidden) {
          opportunityButton.textContent = '新增商機';
          isCreatingOpportunity = false;
        }
      });
    }

    if (taskButton) {
      taskButton.addEventListener('click', async () => {
        if (!currentCustomerCode) {
          const manual = prompt('找不到客戶編碼，請輸入客戶編碼（例如 C4633012）：') || '';
          currentCustomerCode = manual.trim();
          if (!currentCustomerCode) {
            if (taskStatus) {
              taskStatus.hidden = false;
              taskStatus.textContent = '找不到客戶編碼，無法建立任務。';
            }
            return;
          }
        }
        taskButton.disabled = true;
        if (taskStatus) {
          taskStatus.hidden = false;
          taskStatus.textContent = '任務建立中…';
        }
        try {
          const response = await fetch('{{ url_for('create_tasks_api') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customerCode: currentCustomerCode }),
          });
          const raw = await response.text();
          let payload;
          try {
            payload = raw ? JSON.parse(raw) : {};
          } catch (err) {
            payload = { raw };
          }
          if (!response.ok) {
            const message = payload.message || payload.raw || '任務建立失敗，請稍後再試。';
            if (taskStatus) taskStatus.textContent = message;
            taskButton.disabled = false;
            return;
          }
          if (taskStatus) taskStatus.textContent = '任務建立完成。';
        } catch (error) {
          console.error(error);
          if (taskStatus) taskStatus.textContent = '任務建立時發生錯誤，請稍後重試。';
        } finally {
          taskButton.disabled = false;
        }
      });
    }
  </script>
</body>

</html>
