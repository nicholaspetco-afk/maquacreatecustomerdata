"""Utilities to parse sales scripts and submit customer applications."""

from __future__ import annotations

import json
import os
import sys
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, Optional

from .crm_client import CRMClient

ROOT_DIR = Path(__file__).resolve().parents[2]
BUILDER_DIR = ROOT_DIR / "新增優化"
if str(BUILDER_DIR) not in sys.path:
    sys.path.insert(0, str(BUILDER_DIR))

try:
    from customer_builder import parse_customer_text  # type: ignore
except ImportError:  # pragma: no cover

    def parse_customer_text(text: str) -> Dict[str, Any]:  # type: ignore
        raise RuntimeError(
            "無法載入 customer_builder，請確認新增優化/customer_builder.py 是否存在。"
        )


def _env(key: str, default: str) -> str:
    return os.getenv(key, default)


def _sanitize_payment_code(value: str, fallback: str = "99") -> str:
    clean = (value or "").strip()
    if clean.isdigit() and len(clean) <= 2:
        return clean.zfill(2)
    return fallback


def _env_int(key: str, default: int) -> int:
    try:
        return int(os.getenv(key, default))
    except (TypeError, ValueError):
        return default


@dataclass
class SubmissionSettings:
    system_source: str = _env("CFG_SYSTEM_SOURCE", "auto_crm")
    bustype_id: str = _env("CFG_CUSTOMER_BUSTYPE_ID", "1779393122472558598")
    applicant_org_id: str = _env("CFG_APPLY_ORG_ID", "2816765183021312")
    applicant_user_id: str = _env("CFG_APPLICANT_USER_ID", "1634633148216115210")
    applicant_dept_id: str = _env("CFG_APPLICANT_DEPT_ID", "1482538237314465798")
    sales_org_id: str = _env("CFG_SALES_ORG_ID", applicant_org_id)
    trans_type_id: str = _env("CFG_CUSTOMER_TRANS_TYPE_ID", "1476790952607089117")
    customer_industry_id: str = _env("CFG_CUSTOMER_INDUSTRY_ID", "1580721825339932673")
    tax_category: int = _env_int("CFG_TAX_CATEGORY", 0)
    enterprise_nature: int = _env_int("CFG_ENTERPRISE_NATURE", 1)
    license_type: int = _env_int("CFG_LICENSE_TYPE", 3)
    payment_way: str = _sanitize_payment_code(_env("CFG_CUSTOMER_PAYWAY", "99"))
    customer_level_id: Optional[str] = os.getenv("CFG_CUSTOMER_LEVEL_ID") or None
    searchcode_prefix: str = _env("CFG_SEARCHCODE_PREFIX", "AUTO")
    default_region_code: str = _env("CFG_DEFAULT_REGION_CODE", "").strip()
    parent_manage_org_id: Optional[str] = os.getenv("CFG_PARENT_MANAGE_ORG_ID") or ""
    payment_field: str = _env("CFG_FIELD_PAYMENT", "merchantAppliedDetail!payway")
    plan_field: str = _env("CFG_FIELD_PLAN", "merchantCharacter__customerDefine6")
    remark_field: str = _env("CFG_FIELD_REMARK", "merchantCharacter__customerDefine7")
    # 額外欄位：使用方式與月費，可由 .env 指定實際綁定欄位，預設沿用 largeText1/largeText3
    usage_field: str = _env("CFG_FIELD_USAGE", "largeText1")
    monthly_fee_field: str = _env("CFG_FIELD_MONTHLY_FEE", "largeText3")


def _text_map(value: str) -> Dict[str, str]:
    return {"zh_TW": value, "zh_CN": value}


def _assign_field(data: Dict[str, Any], field_code: str, value: Any) -> None:
    if not field_code or value in (None, "", [], {}):
        return
    data[field_code] = value

    if "__" not in field_code:
        return

    prefix, nested_key = field_code.split("__", 1)
    if not nested_key:
        return

    if prefix == "merchantCharacter":
        entity_key = "merchantCharacterEntity!merchantCharacter"
        entity = data.setdefault(entity_key, {})
        if isinstance(entity, dict):
            entity[nested_key] = value
        mirror = data.setdefault("merchantCharacter", {})
        if isinstance(mirror, dict):
            mirror[nested_key] = value
    elif prefix == "customerAddApplyCharacter":
        entity = data.setdefault("customerAddApplyCharacter", {})
        if isinstance(entity, dict):
            entity[nested_key] = value


def build_duplicate_payload(
    normalized: Dict[str, Any], settings: SubmissionSettings
) -> Dict[str, Any]:
    data = {
        "name": normalized.get("displayName"),
        "code": normalized.get("customerCode"),
        "contactTel": normalized.get("contactTel"),
        "address": normalized.get("address"),
        "customerClass": (normalized.get("customerClass") or {}).get("id"),
    }
    return {
        "systemSource": settings.system_source,
        "action": "browse",
        "mainBillNum": "cust_customerCard",
        "data": data,
        "tabInfo": [{"billNum": "cust_customerCard", "mappingType": "0"}],
    }


def build_apply_payload(
    normalized: Dict[str, Any], settings: SubmissionSettings
) -> Dict[str, Any]:
    now = datetime.now()
    apply_code = f"CUST{now:%Y%m%d%H%M%S}"
    sale_area = normalized.get("saleArea") or {}
    owner = normalized.get("owner") or {}
    customer_class = normalized.get("customerClass") or {}
    customer_industry = normalized.get("customerIndustry") or {}
    address_text = normalized.get("address") or ""
    contact_name = normalized.get("contactName") or "聯絡人"
    contact_tel = normalized.get("contactTel") or ""

    address_payload = {"zh_TW": address_text, "zh_CN": address_text}
    contact_block = {
        "isDefault": True,
        "org": settings.sales_org_id,
        "dept": settings.applicant_dept_id,
        "fullName": _text_map(contact_name),
        "mobile": contact_tel,
        "telePhone": contact_tel,
        "_status": "Insert",
        "contacterCharacter": {},
    }
    address_block = {
        "isDefault": True,
        "addressCode": normalized.get("customerCode"),
        "address": address_text,
        "receiver": contact_name,
        "mobile": contact_tel,
        "telePhone": contact_tel,
        "_status": "Insert",
        "addressInfoCharacter": {},
    }
    if settings.default_region_code:
        address_block["regionCode"] = settings.default_region_code
        address_block["mergerName"] = address_text

    person_label = (
        normalized.get("shortName") or normalized.get("baseName") or contact_name
    )

    parent_org_value = (
        settings.parent_manage_org_id
        or normalized.get("parentManageOrg")
        or settings.sales_org_id
    )

    payment_code = _sanitize_payment_code(
        (normalized.get("paymentMethod") or {}).get("id") or "", settings.payment_way
    )
    plan_value = normalized.get("installContent")
    remark_value = normalized.get("remark")

    payload: Dict[str, Any] = {
        "systemSource": settings.system_source,
        "bustype": settings.bustype_id,
        "applyTime": now.strftime("%Y-%m-%d %H:%M:%S"),
        "code": apply_code,
        "org": settings.applicant_org_id,
        "transType": settings.trans_type_id,
        "ower": settings.applicant_user_id,
        "dept": settings.applicant_dept_id,
        "saleArea": sale_area.get("id"),
        "name": _text_map(
            normalized.get("displayName") or normalized.get("shortName") or "新客戶"
        ),
        "shortname": _text_map(
            normalized.get("shortName") or normalized.get("displayName") or "新客戶"
        ),
        "custCode": normalized.get("customerCode"),
        "retailInvestors": False,
        "internalOrg": False,
        "customerClass": customer_class.get("id"),
        "customerIndustry": customer_industry.get("id"),
        "parentManageOrg": parent_org_value,
        "merchantAppliedDetail!belongOrg": settings.sales_org_id,
        "merchantAppliedDetail!searchcode": f"{settings.searchcode_prefix}{normalized.get('customerCode', '')}",
        "merchantAppliedDetail!customerLevel": settings.customer_level_id,
        "enterpriseNature": settings.enterprise_nature,
        "licenseType": settings.license_type,
        "taxPayingCategories": settings.tax_category,
        "enterpriseName": normalized.get("displayName"),
        "leaderName": person_label,
        "leaderNameIdNo": "",
        "creditCode": "",
        "businessLicenseNo": "",
        "regionCode": settings.default_region_code or None,
        "address": address_payload,
        "personName": person_label,
        "contactName": contact_name,
        "contactTel": contact_tel,
        "buildTime": now.strftime("%Y-%m-%d"),
        "money": normalized.get("totalAmount"),
        "scopeModel": 0,
        "scope": {"zh_TW": "", "zh_CN": ""},
        "website": "",
        "wid": "",
        "largeText1": (normalized.get("usageMode") or {}).get("label"),
        "largeText3": normalized.get("monthlyFee"),
        "principals": [
            {
                "isDefault": True,
                "professSalesman": owner.get("id"),
                "specialManagementDep": settings.applicant_dept_id,
                "_status": "Insert",
            }
        ],
        "customerAreas": [
            {
                "isDefault": True,
                "saleAreaId": sale_area.get("id"),
                "_status": "Insert",
            }
        ],
        "merchantAddressInfos": [address_block],
        "merchantContacterInfos": [contact_block],
        "_status": "Insert",
        "customerAddApplyCharacter": {},
        "merchantAppliedDetail!merchantApplyRangeDetailCharacter": {},
        "merchantCharacterEntity!merchantCharacter": {},
    }
    if plan_value:
        payload["largeText2"] = plan_value
    if remark_value:
        payload["largeText4"] = remark_value
    _assign_field(payload, settings.payment_field, payment_code)
    _assign_field(payload, settings.plan_field, normalized.get("installContent"))
    _assign_field(payload, settings.remark_field, normalized.get("remark"))
    # 強制綁定「使用方式」與「月費」到指定欄位，避免 UI 僅顯示 character 欄位而忽略 largeText1/3
    _assign_field(
        payload,
        settings.usage_field,
        (normalized.get("usageMode") or {}).get("label"),
    )
    _assign_field(payload, settings.monthly_fee_field, normalized.get("monthlyFee"))
    return {"data": _cleanup(payload)}


def build_audit_payload(
    application_id: str, settings: SubmissionSettings
) -> Dict[str, Any]:
    return {
        "data": [
            {
                "systemSource": settings.system_source,
                "id": application_id,
            }
        ]
    }


def _cleanup(obj: Any) -> Any:
    if isinstance(obj, dict):
        return {k: _cleanup(v) for k, v in obj.items() if v not in (None, "", [], {})}
    if isinstance(obj, list):
        return [_cleanup(item) for item in obj if item not in (None, "", [], {})]
    return obj


def run_submission(text: str, *, skip_audit: bool = False) -> Dict[str, Any]:
    if not text or not text.strip():
        raise ValueError("請提供銷售文案內容。")

    parse_result = parse_customer_text(text)
    normalized = parse_result["normalized"]
    settings = SubmissionSettings()
    client = CRMClient()

    duplicate_payload = build_duplicate_payload(normalized, settings)
    try:
        duplicate_response = client.customer_duplicate_check(duplicate_payload)
        duplicates = duplicate_response.get("data") or []
    except RuntimeError as exc:
        duplicate_response = {"error": str(exc)}
        duplicates = []

    result: Dict[str, Any] = {
        "duplicateResponse": duplicate_response,
        "submitted": False,
        "applicationResponse": None,
        "auditResponse": None,
    }

    if duplicates:
        result["message"] = "發現重複客戶，已停止送出。"
        return result

    apply_payload = build_apply_payload(normalized, settings)
    try:
        application_response = client.submit_customer_application(apply_payload)
    except RuntimeError as exc:
        message = str(exc)
        result["applicationResponse"] = {"error": message}
        result["message"] = message
        return result

    result["submitted"] = True
    result["applicationResponse"] = application_response
    response_code = str(application_response.get("code") or "")
    if response_code not in {"200", "00000"}:
        result["message"] = application_response.get("message") or "客戶申請提交失敗"
        return result

    if skip_audit:
        result["auditResponse"] = {"skipped": True}
        return result

    application_id = application_response.get("data", {}).get(
        "id"
    ) or application_response.get("data", {}).get("newBizObject", {}).get("id")
    if not application_id:
        result["auditResponse"] = {"skipped": True, "reason": "未取得申請ID"}
        result["message"] = "已送出申請，但取不到申請單 ID，請到 CRM 後台確認。"
        return result

    audit_payload = build_audit_payload(str(application_id), settings)
    try:
        audit_response = client.audit_customer_application(audit_payload)
    except RuntimeError as exc:
        audit_response = {"error": str(exc)}
    result["auditResponse"] = audit_response
    if isinstance(audit_response, dict) and audit_response.get("error"):
        result["message"] = audit_response["error"]
    return result


__all__ = [
    "SubmissionSettings",
    "build_duplicate_payload",
    "build_apply_payload",
    "build_audit_payload",
    "run_submission",
]
