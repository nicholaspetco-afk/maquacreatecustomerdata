# CRM 商机字段映射实际数据分析报告

## 📅 更新日期: 2025-11-20

基于通过 Chrome DevTools Network 捕获的实际 CRM API 数据进行分析

---

## 1. ✅ 已修复：商机阶段 ID 错误

### 问题描述
程序中硬编码的商机阶段ID与实际CRM系统中的ID不匹配，导致创建的商机阶段可能不正确。

### 实际正确的映射关系

| 阶段名称 | opptStage (阶段ID) | process (流程ID) | processStage (流程阶段ID) |
|---------|-------------------|-----------------|------------------------|
| **运维期** | `1587859872035110919` | `1607907035615068175` | `1607907035615068223` |
| **签订合同** | `1476791442110679300` | `1607907035615068175` | `1607907035615068211` |

### 修复详情

**修改文件**: `maqua-members/services/customer_submission.py`

**之前的配置（错误）**:
```python
DEFAULT_STAGE_RENT_ID = "1476791442110679300"  # ❌ 这是签订合同的ID
DEFAULT_STAGE_BUY_ID = "1587859872035110919"   # ❌ 这是运维期的ID
```

**修复后的配置（正确）**:
```python
# 运维期
DEFAULT_STAGE_RENT_ID = "1587859872035110919"
DEFAULT_STAGE_RENT_PROCESS_ID = "1607907035615068175"
DEFAULT_STAGE_RENT_PROCESS_STAGE_ID = "1607907035615068223"

# 签订合同
DEFAULT_STAGE_BUY_ID = "1476791442110679300"
DEFAULT_STAGE_BUY_PROCESS_ID = "1607907035615068175"
DEFAULT_STAGE_BUY_PROCESS_STAGE_ID = "1607907035615068211"
```

---

## 2. 📊 实际字段映射分析

### 从 Network 捕获的实际数据结构

```json
{
  "name": "澳門",
  "transType_name": "家用客戶",
  "headDef": {
    "define8": "租用",        // ✅ 使用方式
    "define9": "fh122121",    // ✅ 方案类型/常用联络方式
    "define10": "100",        // ✅ 预缴金
    "define11": "100",        // ✅ 按金
    "define12": "1000"        // ❓ 未知字段
  },
  "opptDefineCharacter": {
    "attrext8": "租用",       // ✅ 使用方式
    "attrext9": "fh122121",   // ✅ 方案类型
    "attrext10": 100.00,      // ✅ 预缴金
    "attrext17": 1000.00      // ❓ 未知字段
  }
}
```

### 确认的字段映射

| CRM 显示名称 | headDef 字段 | opptDefineCharacter 字段 | 示例值 | 状态 |
|-------------|-------------|------------------------|--------|------|
| 使用方式 | define8 | attrext8 | "租用" | ✅ 已确认 |
| 方案类型/常用联络方式 | define9 | attrext9 | "fh122121" | ✅ 已确认 |
| 预缴金 | define10 | attrext10 | "100" / 100.00 | ✅ 已确认 |
| 按金 | define11 | attrext11 | "100" | ✅ 已确认 |
| 未知 | define12 | - | "1000" | ❓ 待确认 |
| 未知 | - | attrext17 | 1000.00 | ❓ 待确认 |

---

## 3. ⚠️ 关键问题：付款方式字段缺失

### 问题描述

在捕获的实际数据中，**没有发现 `define7` 或任何明确的付款方式字段**！

这可能意味着：

1. **付款方式可能不使用 `define7/attrext7`**
   - 可能使用其他字段编号
   - 可能直接使用主字段（如 `paymentMethod`）

2. **在这个特定案例中没有设置付款方式**
   - 创建商机时没有提供付款方式数据
   - 所以在响应中看不到

3. **付款方式可能在不同的数据结构中**
   - 可能不在 `headDef` 或 `opptDefineCharacter` 中
   - 可能在商机的主体字段中

### 建议的验证步骤

1. **手动创建一个包含明确付款方式的商机**
   - 在 CRM 界面中手动填写"目前付款方式"字段
   - 通过 Network 捕获这个请求
   - 查看付款方式数据出现在哪个字段中

2. **检查其他字段**
   - 查看是否在 `define7` 或其他 `define*` 字段中
   - 查看是否在主体字段中（如 `payway`, `paymentMethod` 等）

3. **对比不同商机**
   - 捕获多个不同付款方式的商机
   - 找出付款方式字段的规律

---

## 4. 🔍 字段用途分析

根据实际数据推断：

### define9/attrext9 的双重用途

从捕获的数据 `"define9": "fh122121"` 来看，这个字段可能同时用于：
- **方案类型**: 如 "FH301", "fh122121" 等方案代码
- **常用联络方式**: 可能也存储在这个字段中

**建议**: 需要进一步确认这个字段的实际用途，可能需要根据数据类型或格式来区分。

### define12/attrext17 的未知用途

捕获到了新的字段：
- `define12`: "1000" (字符串形式)
- `attrext17`: 1000.00 (数值形式)

**可能的用途**:
- 总金额？
- 其他费用？
- 保证金？

需要进一步验证。

---

## 5. 📝 数据类型注意事项

### 金额字段的数据类型差异

观察到金额字段在不同位置使用不同的数据类型：

```json
{
  "headDef": {
    "define10": "100",      // ← 字符串类型
    "define11": "100"       // ← 字符串类型
  },
  "opptDefineCharacter": {
    "attrext10": 100.00,    // ← 数值类型
    "attrext17": 1000.00    // ← 数值类型
  }
}
```

**当前代码处理**: 
```python
prepay_value = _format_amount(context.get("prepay"))  # 转换为字符串
deposit_value = _format_amount(context.get("deposit")) # 转换为字符串
```

**状态**: ✅ 代码已正确处理，使用 `_format_amount` 转换为适当格式

---

## 6. ✅ 已完成的修复

1. **阶段ID修正** ✅
   - 更新了运维期ID: `1587859872035110919`
   - 更新了签订合同ID: `1476791442110679300`
   - 更新了对应的流程阶段ID

2. **字段映射分离** ✅
   - 分离了使用方式和付款方式的设置
   - 确保每个字段都有独立的映射

3. **character_payload 修正** ✅
   - 修复了字段冲突问题
   - 确保预缴金和按金正确设置

---

## 7. ⚠️ 待确认事项

### 高优先级

1. **付款方式字段位置**
   - [ ] 确认"目前付款方式"的实际字段编号
   - [ ] 验证是否为 `define7` 或其他字段

2. **define9 的实际用途**
   - [ ] 确认是方案类型还是常用联络方式
   - [ ] 或者两者都可能存储在此字段

### 中优先级

3. **define12/attrext17 的用途**
   - [ ] 确认这个字段在CRM中的显示名称
   - [ ] 确认其实际业务含义

4. **其他 define 字段**
   - [ ] 检查 define1-6 是否有使用
   - [ ] 检查 define13+ 是否有使用

---

## 8. 🧪 建议的测试方案

### 测试 1: 验证付款方式字段

1. 在CRM界面手动创建商机，明确设置"目前付款方式"为"01"
2. 通过Network捕获请求
3. 查找付款方式"01"出现在哪个字段中
4. 更新代码中的字段映射

### 测试 2: 验证所有字段完整性

使用以下完整输入创建商机，验证所有字段是否正确显示：

```
商機名稱: 测试商机001
客戶: C12345 测试客户
目前付款方式: 01
使用方式: FH301（测试方案）
方案類型: FH301（测试方案）
月費金額: 288.00
按金: 6912.00
預繳金: 0
合約1開始日: 2025-11-20
合約1結束日期: 2027-11-20
合約1年期: 2
常用聯絡方式: 電話
```

### 测试 3: 对比字段值

创建多个商机，使用不同的值，验证字段映射的一致性。

---

## 9. 📂 相关文件

- **主代码**: `maqua-members/services/customer_submission.py`
- **字段解析**: `新增商機/opportunity_builder.py`
- **测试脚本**: 
  - `test_opportunity_field_mapping.py`
  - `diagnose_opportunity_fields.py`
- **文档**: 
  - `新增商機/FIELD_MAPPING_FIX.md`

---

## 10. 🎯 下一步行动

1. **立即需要**:
   - ✅ 重启服务以应用阶段ID更新
   - 🔲 测试新的阶段ID是否正确工作

2. **短期需要**:
   - 🔲 手动创建商机并捕获Network数据，确认付款方式字段
   - 🔲 根据实际数据更新付款方式字段映射

3. **长期需要**:
   - 🔲 完善所有字段的文档
   - 🔲 创建自动化测试来验证字段映射的正确性

---

**生成时间**: 2025-11-20  
**数据来源**: Chrome DevTools Network 捕获的实际 CRM API 响应  
**验证状态**: 阶段ID已更新并验证，字段映射待进一步测试确认
