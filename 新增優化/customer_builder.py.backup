#!/usr/bin/env python3
"""Parse customer briefing text and build CRM-friendly payloads."""

from __future__ import annotations

import argparse
import json
import os
import re
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, Iterable, List, Optional


# 簡易 .env 讀取：在專案根目錄或本目錄存在 .env 時，預先載入環境變量
def _load_env_if_exists() -> None:
    root_env = Path(__file__).resolve().parent.parent / ".env"
    local_env = Path(__file__).resolve().parent / ".env"
    for env_path in (root_env, local_env):
        try:
            if not env_path.exists():
                continue
            for raw in env_path.read_text(encoding="utf-8").splitlines():
                line = raw.strip()
                if not line or line.startswith("#"):
                    continue
                if "=" not in line:
                    continue
                k, v = line.split("=", 1)
                k = k.strip()
                v = v.strip()
                # 若已存在同名環境變量則保留現有值，避免覆蓋外部設定
                if k and (k not in os.environ):
                    os.environ[k] = v
        except Exception:
            # 靜默失敗，不影響後續執行
            pass


_load_env_if_exists()


def env(key: str, default: str) -> str:
    return os.getenv(key, default)


def _payment_code(env_key: str, fallback: str) -> str:
    value = env(env_key, fallback).strip()
    if not value:
        return fallback
    clean = value.replace(" ", "")
    if len(clean) <= 2 and clean.isdigit():
        return clean.zfill(2)
    return fallback


CONFIG: Dict[str, Any] = {
    "saleAreas": [
        {
            "label": "澳門島",
            "id": env("CFG_SALEAREA_MO_ID", "1482639830460399618"),
            "code": env("CFG_SALEAREA_MO_CODE", "001"),
            "keywords": ["澳門", "澳門島", "macau", "macao"],
        },
        {
            "label": "氹仔",
            "id": env("CFG_SALEAREA_TAI_ID", "1482639942129549313"),
            "code": env("CFG_SALEAREA_TAI_CODE", "002"),
            "keywords": ["氹仔", "taipa"],
        },
        {
            "label": "珠海",
            "id": env("CFG_SALEAREA_ZH_ID", "1789854460290793480"),
            "code": env("CFG_SALEAREA_ZH_CODE", "003"),
            "keywords": ["珠海", "zhuhai"],
        },
    ],
    "customerClasses": {
        "家用客戶": {
            "id": env("CFG_CLASS_HOME_ID", "1482638121070755844"),
            "code": env("CFG_CLASS_HOME_CODE", "001"),
        },
        "商用客戶": {
            "id": env("CFG_CLASS_BIZ_ID", "1482638189791805446"),
            "code": env("CFG_CLASS_BIZ_CODE", "002"),
        },
        "政府專案": {
            "id": env("CFG_CLASS_GOV_ID", "1482638816869613570"),
            "code": env("CFG_CLASS_GOV_CODE", "006"),
        },
    },
    "usageModes": {
        "租": {"label": "租", "id": env("CFG_USAGE_RENT_ID", "USAGE_RENT_ID")},
        "買": {"label": "買", "id": env("CFG_USAGE_BUY_ID", "USAGE_BUY_ID")},
    },
    "ownerOptions": [
        {
            "keywords": ["寧", "ning"],
            "owner": {
                "id": env("CFG_OWNER_JAMES_ID", "1634633148216115210"),
                "name": "James",
            },
        },
        {
            "keywords": ["成", "cheng"],
            "owner": {
                "id": env("CFG_OWNER_LIANG_ID", "1675717018645954563"),
                "name": "梁必成",
            },
        },
        {
            "keywords": ["liz", "莉茲"],
            "owner": {
                "id": env("CFG_OWNER_LIZ_ID", "1804041613437042698"),
                "name": "李潤婷",
            },
        },
    ],
    "defaultOwner": {
        "id": env(
            "CFG_OWNER_DEFAULT_ID", env("CFG_OWNER_JAMES_ID", "1634633148216115210")
        ),
        "name": env("CFG_OWNER_DEFAULT_NAME", "James"),
    },
    "qualification": {
        "enterpriseType": env("CFG_QUAL_ENTERPRISE", "個人"),
        "qualificationType": env("CFG_QUAL_TYPE", "其他"),
    },
    "characterKeys": {
        "totalAmount": env("CFG_CHAR_TOTAL_AMOUNT", "CHAR_TOTAL_AMOUNT"),
        "monthlyFee": env("CFG_CHAR_MONTHLY_FEE", "CHAR_MONTHLY_FEE"),
        "deposit": env("CFG_CHAR_DEPOSIT", "CHAR_DEPOSIT"),
        "prepay": env("CFG_CHAR_PREPAY", "CHAR_PREPAY"),
        "installTime": env("CFG_CHAR_INSTALL_TIME", "CHAR_INSTALL_TIME"),
        "installContent": env("CFG_CHAR_INSTALL_CONTENT", "CHAR_INSTALL_CONTENT"),
        "remark": env("CFG_CHAR_REMARK", "CHAR_REMARK"),
        "usageMode": env("CFG_CHAR_USAGE_MODE", "CHAR_USAGE_MODE"),
        "paymentMethod": env("CFG_CHAR_PAYMENT_METHOD", "CHAR_PAYMENT_METHOD"),
    },
}

_credit_installment = {
    "label": "信用卡分期",
    "id": _payment_code("CFG_PAYMENT_CARD_INSTALLMENT_ID", "02"),
}

CONFIG["paymentMethods"] = {
    "一次性全繳": {
        "label": "一次性全繳",
        "id": _payment_code("CFG_PAYMENT_ONETIME_ID", "01"),
    },
    "信用卡分期": _credit_installment,
    "銀行卡自動轉賬": {
        "label": "銀行卡自動轉賬",
        "id": _payment_code("CFG_PAYMENT_AUTO_DEBIT_ID", "03"),
    },
    "季度收費": {
        "label": "季度收費",
        "id": _payment_code("CFG_PAYMENT_QUARTERLY_ID", "04"),
    },
    "年度收費": {
        "label": "年度收費",
        "id": _payment_code("CFG_PAYMENT_ANNUAL_ID", "05"),
    },
    "試用": {
        "label": "試用",
        "id": _payment_code("CFG_PAYMENT_TRIAL_ID", "06"),
    },
    "每月收費": {
        "label": "每月收費",
        "id": _payment_code("CFG_PAYMENT_MONTHLY_ID", "07"),
    },
}

_PAYMENT_ALIASES = {
    "一次性付款": "一次性全繳",
    "一次性繳交": "一次性全繳",
    "季度月費": "季度收費",
    "季度付款": "季度收費",
    "月費": "每月收費",
    "每月月費": "每月收費",
}

for alias, canonical in _PAYMENT_ALIASES.items():
    target = CONFIG["paymentMethods"].get(canonical)
    if target:
        CONFIG["paymentMethods"][alias] = target

for alias in ("信用卡付費", "信用卡付款", "信用卡刷卡", "信用卡"):
    CONFIG["paymentMethods"][alias] = CONFIG["paymentMethods"]["信用卡分期"]

LABEL_MAP = {
    "客戶名稱": "customerName",
    "聯繫電話": "contactPhone",
    "目前付費方式": "paymentMethod",
    "安裝時間": "installTime",
    "安裝內容": "installContent",
    "方案類型": "installContent",
    "總金額": "totalAmount",
    "聯絡地址": "address",
    "備註": "remark",
    "備注": "remark",
    "客戶分類": "customerCategory",
    "付款方式": "paymentMethod",
    "使用方式": "usageMode",
    "月費金額": "monthlyFee",
    "按金": "deposit",
    "預繳金": "prepay",
    "負責人": "ownerHint",
}


def strip(value: Optional[str]) -> str:
    return value.strip() if value else ""


def parse_lines(text: str) -> Dict[str, str]:
    parsed: Dict[str, str] = {}
    for raw_line in text.splitlines():
        line = strip(raw_line)
        if not line:
            continue
        parts = re.split(r"[：:]", line, maxsplit=1)
        if len(parts) != 2:
            continue
        label, value = strip(parts[0]), strip(parts[1])
        key = LABEL_MAP.get(label)
        if key:
            parsed[key] = value
    return parsed


def extract_choice(value: Optional[str], candidates: Iterable[str]) -> Optional[str]:
    if not value:
        return None
    cleaned = re.sub(r"\s+", "", value)
    paren_matches = re.findall(r"[（(]([^（）()]+)[）)]", cleaned)
    if paren_matches:
        candidate = re.sub(r"(這次試試|本次|試試)", "", paren_matches[-1])
        candidate = candidate.strip()
        if candidate:
            for choice in candidates:
                if choice in candidate:
                    return choice
    for choice in candidates:
        if choice.replace(" ", "") in cleaned:
            return choice
    return None


def number_from_string(value: Optional[str]) -> Optional[float]:
    if value is None:
        return None
    normalized = re.sub(r"[^0-9.\-]", "", value)
    if not normalized:
        return None
    try:
        return float(normalized)
    except ValueError:
        return None


def resolve_sale_area(address: str) -> Optional[Dict[str, Any]]:
    lowered = address.lower()
    for area in CONFIG["saleAreas"]:
        if any(keyword.lower() in lowered for keyword in area.get("keywords", [])):
            return area
    return None


def resolve_owner(raw_text: str, owner_hint: Optional[str]) -> Dict[str, Any]:
    candidates = []
    if owner_hint:
        candidates.append(owner_hint)
    candidates.append(raw_text)
    for candidate in candidates:
        lowered = candidate.lower()
        for option in CONFIG["ownerOptions"]:
            if any(keyword in lowered for keyword in option["keywords"]):
                return option["owner"]
    return CONFIG["defaultOwner"]


def parse_install_time(value: Optional[str]) -> Optional[Dict[str, str]]:
    if not value:
        return None
    text = value.strip()
    full_match = re.search(
        r"(20\d{2})[./年-]\s*(\d{1,2})[./月-]\s*(\d{1,2})(?:[日号]\s*)?(?:(\d{1,2}):(\d{2}))?",
        text,
    )
    if full_match:
        year, month, day, hour, minute = full_match.groups()
        hour = hour or "00"
        minute = minute or "00"
        return {
            "display": f"{int(year):04d}-{int(month):02d}-{int(day):02d} {int(hour):02d}:{int(minute):02d}",
            "iso": datetime(
                int(year), int(month), int(day), int(hour), int(minute)
            ).isoformat(),
        }
    md_match = re.search(r"(\d{1,2})\s*月\s*(\d{1,2})\s*日", text)
    time_match = re.search(r"(\d{1,2}):(\d{2})", text)
    if md_match:
        now_year = datetime.now().year
        month, day = md_match.groups()
        hour = time_match.group(1) if time_match else "00"
        minute = time_match.group(2) if time_match else "00"
        return {
            "display": f"{now_year:04d}-{int(month):02d}-{int(day):02d} {int(hour):02d}:{int(minute):02d}",
            "iso": datetime(
                now_year, int(month), int(day), int(hour), int(minute)
            ).isoformat(),
        }
    return {"display": text, "iso": None}


def build_crm_payload(normalized: Dict[str, Any]) -> Dict[str, Any]:
    ck = CONFIG["characterKeys"]
    character_payload: Dict[str, Any] = {}

    def add_if_present(key: str, value: Any) -> None:
        if value is not None:
            character_payload[key] = value

    add_if_present(ck["totalAmount"], normalized.get("totalAmount"))
    add_if_present(ck["monthlyFee"], normalized.get("monthlyFee"))
    add_if_present(ck["deposit"], normalized.get("deposit"))
    add_if_present(ck["prepay"], normalized.get("prepay"))
    add_if_present(ck["installTime"], normalized.get("installTime", {}).get("display"))
    add_if_present(ck["installContent"], normalized.get("installContent"))
    add_if_present(ck["remark"], normalized.get("remark"))
    add_if_present(ck["usageMode"], normalized.get("usageMode", {}).get("label"))
    add_if_present(
        ck["paymentMethod"], normalized.get("paymentMethod", {}).get("label")
    )

    # 建立 CRM 直接使用的欄位映射
    add_application_payload = {
        "name": normalized.get("displayName"),
        "code": normalized.get("customerCode"),
        "contactTel": normalized.get("contactTel"),
        "contactName": normalized.get("contactName"),
        "saleAreaId": normalized.get("saleArea", {}).get("id"),
        "ownerId": normalized.get("owner", {}).get("id"),
        "usageMode": normalized.get("usageMode", {}).get("label"),
        "paymentMethod": normalized.get("paymentMethod", {}).get("label"),
        "monthlyFee": normalized.get("monthlyFee"),
        "deposit": normalized.get("deposit"),
        "prepay": normalized.get("prepay"),
        "totalAmount": normalized.get("totalAmount"),
        "installTime": normalized.get("installTime", {}).get("display"),
        "installContent": normalized.get("installContent"),
        "remark": normalized.get("remark"),
        "customerClassId": normalized.get("customerClass", {}).get("id"),
        "qualification": normalized.get("qualification"),
        "characters": character_payload,
    }

    # 加入直接映射到 CRM 欄位的資料
    # 付款方式 -> merchantAppliedDetail!payway
    if normalized.get("paymentMethod", {}).get("label"):
        add_application_payload["merchantAppliedDetail"] = {
            "payway": normalized.get("paymentMethod", {}).get("label")
        }
    
    # 使用方式 -> largeText1
    if normalized.get("usageMode", {}).get("label"):
        add_application_payload["largeText1"] = normalized.get("usageMode", {}).get("label")
    
    # 方案內容/方案類型 -> largeText2
    if normalized.get("installContent"):
        add_application_payload["largeText2"] = normalized.get("installContent")
    
    # 月費金額 -> largeText3
    if normalized.get("monthlyFee") is not None:
        add_application_payload["largeText3"] = str(normalized.get("monthlyFee"))
    
    # 備註 -> largeText4 或保留原有 remark
    if normalized.get("remark"):
        add_application_payload["largeText4"] = normalized.get("remark")

    return {
        "duplicateCheck": {
            "name": normalized.get("displayName"),
            "code": normalized.get("customerCode"),
            "contactTel": normalized.get("contactTel"),
            "address": normalized.get("address"),
            "customerClassId": normalized.get("customerClass", {}).get("id"),
        },
        "addApplication": add_application_payload,
        "archive": {
            "name": normalized.get("displayName"),
            "code": normalized.get("customerCode"),
            "shortname": normalized.get("shortName"),
            "address": normalized.get("address"),
            "saleArea": normalized.get("saleArea"),
            "owner": normalized.get("owner"),
        },
    }


def parse_customer_text(text: str) -> Dict[str, Any]:
    if not strip(text):
        raise ValueError("輸入內容不可為空")

    raw_fields = parse_lines(text)
    warnings: List[str] = []

    name_field = raw_fields.get("customerName", "")
    code_match = re.search(r"c\d{3,}", name_field, re.IGNORECASE)
    customer_code = code_match.group(0).upper() if code_match else ""
    if not customer_code:
        warnings.append("未偵測到客戶編碼 (需包含 C 開頭的編號)")

    base_name = strip(re.sub(customer_code, "", name_field, flags=re.IGNORECASE))
    contact_phone_field = raw_fields.get("contactPhone", "")
    digits = "".join(re.findall(r"\d+", contact_phone_field))
    contact_tel = digits or ""
    if not contact_tel:
        warnings.append("未偵測到聯繫電話")
    contact_name = strip(contact_phone_field.replace(contact_tel, "")) or "聯絡人"
    display_name = f"{customer_code}{base_name}{contact_tel}".strip()
    short_name = f"{customer_code}{base_name}".strip() or customer_code

    category_label = (
        extract_choice(
            raw_fields.get("customerCategory"),
            CONFIG["customerClasses"].keys(),
        )
        or "商用客戶"
    )
    customer_class = CONFIG["customerClasses"].get(category_label)
    if not customer_class:
        warnings.append(
            f"無法識別的客戶分類：{raw_fields.get('customerCategory', '未提供')}"
        )

    payment_label = (
        extract_choice(
            raw_fields.get("paymentMethod"),
            CONFIG["paymentMethods"].keys(),
        )
        or "季度收費"
    )
    payment_method = CONFIG["paymentMethods"].get(payment_label)
    if not payment_method:
        warnings.append(
            f"無法識別的付款方式：{raw_fields.get('paymentMethod', '未提供')}"
        )

    usage_label = (
        extract_choice(
            raw_fields.get("usageMode"),
            CONFIG["usageModes"].keys(),
        )
        or "租"
    )
    usage_mode = CONFIG["usageModes"].get(usage_label)

    monthly_fee = number_from_string(raw_fields.get("monthlyFee"))
    deposit = number_from_string(raw_fields.get("deposit"))
    prepay = number_from_string(raw_fields.get("prepay"))
    total_amount = number_from_string(raw_fields.get("totalAmount"))

    address = raw_fields.get("address", "")
    sale_area = resolve_sale_area(address)
    if not sale_area and address:
        warnings.append("無法依地址判斷銷售區域，請手動確認")

    install_time = parse_install_time(raw_fields.get("installTime"))
    owner = resolve_owner(text, raw_fields.get("ownerHint"))

    normalized = {
        "customerCode": customer_code,
        "baseName": base_name,
        "displayName": display_name,
        "shortName": short_name,
        "contactTel": contact_tel,
        "contactName": contact_name,
        "address": address,
        "saleArea": sale_area,
        "paymentMethod": payment_method,
        "usageMode": usage_mode,
        "monthlyFee": monthly_fee,
        "deposit": deposit,
        "prepay": prepay,
        "totalAmount": total_amount,
        "installContent": raw_fields.get("installContent", ""),
        "remark": raw_fields.get("remark", ""),
        "installTime": install_time,
        "customerClass": (
            {**customer_class, "label": category_label} if customer_class else None
        ),
        "paymentLabel": payment_label,
        "usageLabel": usage_label,
        "owner": owner,
        "qualification": CONFIG["qualification"],
        "rawFields": raw_fields,
    }

    crm_payload = build_crm_payload(normalized)

    return {
        "normalized": normalized,
        "crmPayload": crm_payload,
        "warnings": warnings,
    }


def main() -> None:
    parser = argparse.ArgumentParser(
        description="Parse customer briefing text and output CRM payload JSON."
    )
    parser.add_argument(
        "source",
        nargs="?",
        help="Path to the briefing text file (defaults to STDIN if omitted).",
    )
    parser.add_argument(
        "--text",
        help="Raw text snippet to parse (overrides source file).",
    )
    parser.add_argument(
        "--output",
        help="Optional path to write the resulting JSON payload.",
    )
    parser.add_argument(
        "--pretty",
        action="store_true",
        help="Pretty-print JSON with indentation.",
    )
    args = parser.parse_args()

    if args.text:
        content = args.text
    elif args.source:
        content = Path(args.source).read_text(encoding="utf-8")
    else:
        content = os.sys.stdin.read()

    result = parse_customer_text(content)
    json_text = json.dumps(
        result,
        ensure_ascii=False,
        indent=2 if args.pretty or args.output else None,
    )

    if args.output:
        Path(args.output).write_text(json_text + "\n", encoding="utf-8")
    else:
        print(json_text)


if __name__ == "__main__":
    main()
